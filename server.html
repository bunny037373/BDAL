<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Server</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #2c2f33;
      color: white;
      display: flex;
    }
    .sidebar {
      width: 260px;
      background: #23272a;
      padding: 15px;
      height: 100vh;
      box-sizing: border-box;
    }
    .server-header {
      text-align: center;
      margin-bottom: 20px;
    }
    .server-header img {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
    }
    .channels {
      margin-top: 20px;
    }
    .channels h3 {
      font-size: 14px;
      margin-bottom: 10px;
    }
    .channels ul {
      list-style: none;
      padding: 0;
    }
    .channels li {
      padding: 8px 10px;
      background: #2c2f33;
      margin-bottom: 5px;
      border-radius: 4px;
      cursor: pointer;
    }
    .chat {
      flex: 1;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    .chat-header {
      background: #2c2f33;
      padding: 15px;
      border-bottom: 1px solid #444;
    }
    .chat-messages {
      flex: 1;
      padding: 20px;
      overflow-y: scroll;
    }
    .message {
      margin-bottom: 15px;
    }
    .message .sender {
      font-weight: bold;
      cursor: pointer;
    }
    .message img.pfp {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      margin-right: 10px;
      vertical-align: middle;
      object-fit: cover;
      cursor: pointer;
    }
    .message .text {
      display: inline;
    }
    .message small {
      color: #aaa;
      margin-left: 8px;
      font-size: 12px;
    }
    .message-controls {
      margin-left: 42px;
    }
    .message-controls button {
      margin-right: 5px;
      padding: 2px 6px;
      font-size: 12px;
    }
    .chat-input {
      display: flex;
      padding: 15px;
      border-top: 1px solid #444;
      background: #2c2f33;
    }
    .chat-input input {
      flex: 1;
      padding: 10px;
      border-radius: 5px;
      border: none;
      margin-right: 10px;
      font-size: 14px;
    }
    .chat-input button {
      padding: 10px 20px;
      background: #5865F2;
      border: none;
      border-radius: 5px;
      color: white;
      cursor: pointer;
    }
    .owner-controls {
      margin-top: 10px;
      text-align: center;
    }
    .owner-controls button {
      margin: 5px;
      background: #7289DA;
      padding: 8px 14px;
      border: none;
      color: white;
      border-radius: 4px;
      font-size: 13px;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <div class="sidebar">
    <div class="server-header">
      <img id="serverIcon" src="default.png" alt="Server Icon">
      <h2 id="serverName">Loading...</h2>
      <div class="owner-controls" id="ownerControls" style="display: none;">
        <button onclick="changeServerIcon()">Change Icon</button>
        <button onclick="createChannel('text')">+ Text Channel</button>
        <button onclick="createChannel('voice')">+ Voice Channel</button>
      </div>
    </div>
    <div class="channels">
      <h3>Channels</h3>
      <ul id="channelList"></ul>
    </div>
  </div>

  <div class="chat">
    <div class="chat-header">
      <h3 id="channelName">#general</h3>
    </div>
    <div class="chat-messages" id="chatMessages"></div>
    <div class="chat-input">
      <input id="messageInput" type="text" placeholder="Type a message..." />
      <button onclick="sendMessage()">Send</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, collection, addDoc, onSnapshot,
      updateDoc, deleteDoc, query, where, getDocs
    } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCGGosrc7Ikl1xPnZri5sHuMvEUBB1f2YU",
      authDomain: "mydiscordclone-fc2be.firebaseapp.com",
      projectId: "mydiscordclone-fc2be",
      storageBucket: "mydiscordclone-fc2be.appspot.com",
      messagingSenderId: "599134697544",
      appId: "1:599134697544:web:0961e501044324e52b807d"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const serverId = sessionStorage.getItem("currentServer");
    let currentUser = null;
    let currentChannel = null;
    let isOwner = false;

    const serverName = document.getElementById("serverName");
    const serverIcon = document.getElementById("serverIcon");
    const ownerControls = document.getElementById("ownerControls");
    const channelList = document.getElementById("channelList");
    const chatMessages = document.getElementById("chatMessages");

    onAuthStateChanged(auth, async (user) => {
      if (!user) return location.href = "login.html";
      currentUser = user;

      const serverSnap = await getDoc(doc(db, "servers", serverId));
      const serverData = serverSnap.data();

      serverName.textContent = serverData.name;
      serverIcon.src = serverData.serverIcon || "default.png";

      isOwner = serverData.owner === user.uid;
      if (isOwner) ownerControls.style.display = "block";

      loadChannels();
    });

    async function loadChannels() {
      const channelsRef = collection(db, "servers", serverId, "channels");
      const snapshot = await getDocs(channelsRef);
      channelList.innerHTML = "";

      snapshot.forEach(docSnap => {
        const channel = docSnap.data();
        const li = document.createElement("li");
        li.textContent = channel.name;
        li.onclick = () => switchChannel(docSnap.id, channel.name);
        channelList.appendChild(li);
      });

      if (snapshot.docs.length > 0) {
        const first = snapshot.docs[0];
        switchChannel(first.id, first.data().name);
      }
    }

    async function switchChannel(id, name) {
      currentChannel = id;
      document.getElementById("channelName").textContent = "#" + name;
      chatMessages.innerHTML = "";

      const msgRef = collection(db, "servers", serverId, "channels", id, "messages");
      onSnapshot(msgRef, (snapshot) => {
        chatMessages.innerHTML = "";
        snapshot.forEach(async docSnap => {
          const msg = docSnap.data();
          const userSnap = await getDoc(doc(db, "users", msg.senderId));
          const userData = userSnap.data();

          const div = document.createElement("div");
          div.className = "message";

          div.innerHTML = `
            <img src="${userData.profilePicture || 'default.png'}" class="pfp" onclick="openUser('${msg.senderId}')">
            <span class="sender" onclick="openUser('${msg.senderId}')">${userData.username || 'User'}</span>
            <small>${new Date(msg.timestamp).toLocaleTimeString()}</small>
            <div class="text">${msg.text}</div>
          `;

          if (msg.senderId === currentUser.uid || isOwner) {
            const controls = document.createElement("div");
            controls.className = "message-controls";

            const editBtn = document.createElement("button");
            editBtn.textContent = "Edit";
            editBtn.onclick = () => {
              const newText = prompt("Edit message:", msg.text);
              if (newText) {
                updateDoc(doc(db, "servers", serverId, "channels", currentChannel, "messages", docSnap.id), {
                  text: newText
                });
              }
            };

            const deleteBtn = document.createElement("button");
            deleteBtn.textContent = "Delete";
            deleteBtn.onclick = () => {
              deleteDoc(doc(db, "servers", serverId, "channels", currentChannel, "messages", docSnap.id));
            };

            controls.appendChild(editBtn);
            controls.appendChild(deleteBtn);
            div.appendChild(controls);
          }

          chatMessages.appendChild(div);
        });
      });
    }

    window.sendMessage = async function () {
      const input = document.getElementById("messageInput");
      const text = input.value.trim();
      if (!text || !currentChannel) return;

      await addDoc(collection(db, "servers", serverId, "channels", currentChannel, "messages"), {
        text,
        senderId: currentUser.uid,
        timestamp: Date.now()
      });
      input.value = "";
    };

    window.openUser = function (uid) {
      sessionStorage.setItem("viewUser", uid);
      window.location.href = "user.html";
    };

    window.createChannel = async function (type) {
      const name = prompt(`Enter ${type} channel name:`);
      if (!name) return;
      await addDoc(collection(db, "servers", serverId, "channels"), {
        name,
        type,
        createdAt: Date.now()
      });
      loadChannels();
    };

    window.changeServerIcon = function () {
      const input = document.createElement("input");
      input.type = "file";
      input.accept = "image/*";
      input.click();

      input.onchange = async () => {
        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = async () => {
          const base64 = reader.result;
          await updateDoc(doc(db, "servers", serverId), {
            serverIcon: base64
          });
          serverIcon.src = base64;
        };
        reader.readAsDataURL(file);
      };
    };
  </script>

</body>
</html>
