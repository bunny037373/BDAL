<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Server</title>
  <style>
    body { margin: 0; font-family: Arial, sans-serif; display: flex; height: 100vh; }
    #channelList {
      width: 200px;
      background: #2f3136;
      color: white;
      padding: 15px;
      overflow-y: auto;
    }
    #channelList button {
      width: 100%;
      margin: 5px 0;
      padding: 8px;
      background: #40444b;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 4px;
    }
    .main { flex: 1; display: flex; flex-direction: column; }
    #messageList {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      background: #f0f0f0;
    }
    .input-area {
      display: flex;
      padding: 10px;
      background: #ddd;
    }
    .input-area input {
      flex: 1;
      padding: 10px;
    }
    .input-area button {
      padding: 10px 20px;
      background: #5865F2;
      color: white;
      border: none;
    }
  </style>
</head>
<body>
  <div id="channelList">
    <h3>Channels</h3>
    <button id="addChannelBtn" onclick="addChannel()" style="display:none;">+ Add Channel</button>
    <button id="inviteBtn" onclick="showInviteCode()" style="display:none;">Invite</button>
    <div id="channelButtons"></div>
  </div>
  <div class="main">
    <div id="messageList">Select a channel to view messages.</div>
    <div class="input-area">
      <input id="messageInput" placeholder="Type your message..." />
      <button onclick="sendMessage()">Send</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      collection,
      addDoc,
      onSnapshot,
      query,
      orderBy
    } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCGGosrc7Ikl1xPnZri5sHuMvEUBB1f2YU",
      authDomain: "mydiscordclone-fc2be.firebaseapp.com",
      projectId: "mydiscordclone-fc2be",
      storageBucket: "mydiscordclone-fc2be.appspot.com",
      messagingSenderId: "599134697544",
      appId: "1:599134697544:web:0961e501044324e52b807d"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const serverId = sessionStorage.getItem("currentServer");
    let currentChannel = null;
    let currentUser = null;
    let userCache = {};

    const messageList = document.getElementById("messageList");

    onAuthStateChanged(auth, async (user) => {
      if (!user) return (window.location.href = "login.html");
      currentUser = user;

      const serverRef = doc(db, "servers", serverId);
      const serverSnap = await getDoc(serverRef);
      const serverData = serverSnap.data();

      console.log("Your UID:", user.uid);
      console.log("Server Owner UID:", serverData.owner);

      // Show owner-only buttons
      if (user.uid === serverData.owner) {
        document.getElementById("addChannelBtn").style.display = "block";
        document.getElementById("inviteBtn").style.display = "block";
      }

      loadChannels();
    });

    async function loadChannels() {
      const channelsRef = collection(db, "servers", serverId, "channels");
      onSnapshot(channelsRef, (snapshot) => {
        document.getElementById("channelButtons").innerHTML = "";
        snapshot.forEach((docSnap) => {
          const channel = docSnap.data();
          const btn = document.createElement("button");
          btn.textContent = channel.name;
          btn.onclick = () => selectChannel(docSnap.id);
          document.getElementById("channelButtons").appendChild(btn);
        });
      });
    }

    async function selectChannel(channelId) {
      currentChannel = channelId;
      messageList.innerHTML = "";
      const messagesRef = collection(db, "servers", serverId, "channels", currentChannel, "messages");
      const q = query(messagesRef, orderBy("timestamp", "asc"));
      onSnapshot(q, async (snapshot) => {
        messageList.innerHTML = "";
        for (const docSnap of snapshot.docs) {
          const msg = docSnap.data();
          const userId = msg.userId;

          if (!userCache[userId]) {
            const userDoc = await getDoc(doc(db, "users", userId));
            userCache[userId] = userDoc.exists() ? userDoc.data() : { displayName: "Unknown", profilePicture: "default.png" };
          }

          const userData = userCache[userId];

          const msgDiv = document.createElement("div");
          msgDiv.style.display = "flex";
          msgDiv.style.alignItems = "center";
          msgDiv.style.marginBottom = "10px";

          const img = document.createElement("img");
          img.src = userData.profilePicture || "default.png";
          img.style.width = "40px";
          img.style.height = "40px";
          img.style.borderRadius = "50%";
          img.style.marginRight = "10px";

          const textBlock = document.createElement("div");
          const name = document.createElement("strong");
          name.textContent = userData.displayName || "User";
          const text = document.createElement("p");
          text.textContent = msg.text;
          text.style.margin = "3px 0";

          textBlock.appendChild(name);
          textBlock.appendChild(text);
          msgDiv.appendChild(img);
          msgDiv.appendChild(textBlock);
          messageList.appendChild(msgDiv);
        }
        messageList.scrollTop = messageList.scrollHeight;
      });
    }

    window.sendMessage = async function () {
      const input = document.getElementById("messageInput");
      const text = input.value.trim();
      if (!text || !currentChannel) return;

      await addDoc(collection(db, "servers", serverId, "channels", currentChannel, "messages"), {
        text,
        userId: currentUser.uid,
        timestamp: Date.now()
      });

      input.value = "";
    };

    window.addChannel = async function () {
      const name = prompt("Channel name?");
      if (!name) return;

      await addDoc(collection(db, "servers", serverId, "channels"), {
        name
      });
    };

    window.showInviteCode = async function () {
      const serverDoc = await getDoc(doc(db, "servers", serverId));
      const code = serverDoc.data().inviteCode;
      prompt("Share this invite code:", code);
    };
  </script>
</body>
</html>
