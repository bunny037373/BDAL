<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Server</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: #f4f4f4;
    }

    .header {
      background: #5865F2;
      color: white;
      padding: 15px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .header h2 {
      margin: 0;
    }

    .chat-box {
      padding: 15px;
      max-height: 50vh;
      overflow-y: auto;
    }

    .message {
      background: white;
      border-radius: 8px;
      margin-bottom: 10px;
      padding: 10px;
      display: flex;
      gap: 10px;
      align-items: center;
      position: relative;
    }

    .profile-pic {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
    }

    .content {
      flex: 1;
    }

    .message-meta {
      font-size: 12px;
      color: gray;
    }

    .message button {
      background: transparent;
      border: none;
      cursor: pointer;
      color: gray;
    }

    .input-box {
      display: flex;
      padding: 10px;
      background: #ddd;
      position: fixed;
      bottom: 0;
      width: 100%;
    }

    .input-box input {
      flex: 1;
      padding: 10px;
    }

    .input-box button {
      padding: 10px 20px;
      background: #5865F2;
      color: white;
      border: none;
      cursor: pointer;
    }

    .admin-panel {
      padding: 10px;
      background: #eee;
    }

    .admin-panel input {
      margin: 4px;
    }

    .channel-switcher {
      margin: 8px 0;
    }

    .role {
      display: inline-block;
      padding: 3px 6px;
      border-radius: 4px;
      font-size: 12px;
      margin-left: 6px;
      color: white;
    }
  </style>
</head>
<body>
  <div class="header">
    <h2 id="serverName">Server</h2>
    <button onclick="editServer()">Edit Server</button>
    <button onclick="createChannel()">+ Channel</button>
    <button onclick="createVoiceChannel()">+ Voice Channel</button>
    <select id="channelSelect" class="channel-switcher" onchange="switchChannel(this.value)"></select>
  </div>

  <div id="chatBox" class="chat-box">Loading...</div>

  <div class="admin-panel" id="adminControls" style="display:none;">
    <input id="roleName" placeholder="Role Name" />
    <input type="color" id="roleColor" />
    <button onclick="createRole()">Create Role</button>
    <input id="inviteCode" placeholder="Custom Invite Code" />
    <button onclick="generateInvite()">Generate Invite</button>
  </div>

  <div class="input-box">
    <input type="text" id="messageInput" placeholder="Message..." />
    <button onclick="sendMessage()">Send</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc,
      updateDoc,
      deleteDoc,
      addDoc,
      collection,
      query,
      orderBy,
      onSnapshot
    } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCGGosrc7Ikl1xPnZri5sHuMvEUBB1f2YU",
      authDomain: "mydiscordclone-fc2be.firebaseapp.com",
      projectId: "mydiscordclone-fc2be",
      storageBucket: "mydiscordclone-fc2be.appspot.com",
      messagingSenderId: "599134697544",
      appId: "1:599134697544:web:0961e501044324e52b807d"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const serverId = sessionStorage.getItem("currentServer");
    const viewingAs = sessionStorage.getItem("adminViewingAs");
    let currentUser, currentUid, currentChannel = "general", isOwner = false, isAdmin = false, isVerified = false;

    const serverName = document.getElementById("serverName");
    const chatBox = document.getElementById("chatBox");
    const channelSelect = document.getElementById("channelSelect");
    const adminControls = document.getElementById("adminControls");
    const messageInput = document.getElementById("messageInput");

    onAuthStateChanged(auth, async (user) => {
      if (!user) return location.href = "login.html";
      currentUser = user;
      currentUid = viewingAs || user.uid;

      const userDoc = await getDoc(doc(db, "users", currentUid));
      const serverDoc = await getDoc(doc(db, "servers", serverId));
      const userData = userDoc.data();
      const serverData = serverDoc.data();

      isOwner = serverData.owner === currentUid;
      isAdmin = userData.role === "admin";
      isVerified = userData.verified === true;

      if (isOwner || isAdmin) adminControls.style.display = "block";

      serverName.textContent = serverData.name || "Unnamed Server";

      loadChannels();
      loadMessages();
    });

    async function loadChannels() {
      const snap = await getDocs(collection(db, "servers", serverId, "channels"));
      channelSelect.innerHTML = "";
      snap.forEach(doc => {
        const opt = document.createElement("option");
        opt.value = doc.id;
        opt.textContent = doc.id;
        channelSelect.appendChild(opt);
      });
    }

    function switchChannel(name) {
      currentChannel = name;
      loadMessages();
    }

    function loadMessages() {
      const q = query(collection(db, "servers", serverId, "channels", currentChannel, "messages"), orderBy("timestamp"));
      onSnapshot(q, async (snapshot) => {
        chatBox.innerHTML = "";
        snapshot.forEach(async (msgDoc) => {
          const msg = msgDoc.data();
          const div = document.createElement("div");
          div.className = "message";

          const userDoc = await getDoc(doc(db, "users", msg.sender));
          const userData = userDoc.data();
          const img = document.createElement("img");
          img.src = userData?.profilePicture || "default.png";
          img.className = "profile-pic";
          img.onclick = () => {
            sessionStorage.setItem("viewUserId", msg.sender);
            window.location.href = "user.html";
          };

          const content = document.createElement("div");
          content.className = "content";

          const date = new Date(msg.timestamp).toLocaleString();
          content.innerHTML = `
            <div><b style="cursor:pointer;" onclick="sessionStorage.setItem('viewUserId','${msg.sender}');location.href='user.html';">
              ${msg.displayName}
            </b>
            ${msg.roleName ? `<span class="role" style="background:${msg.roleColor}">${msg.roleName}</span>` : ""}</div>
            <div>${msg.text}</div>
            <div class="message-meta">${date}</div>
          `;

          div.appendChild(img);
          div.appendChild(content);

          const canDelete = isAdmin || isOwner || msg.sender === currentUid;
          const canEdit = msg.sender === currentUid;

          if (canDelete) {
            const del = document.createElement("button");
            del.textContent = "🗑";
            del.onclick = () => deleteDoc(doc(db, "servers", serverId, "channels", currentChannel, "messages", msgDoc.id));
            div.appendChild(del);
          }

          if (canEdit) {
            const edit = document.createElement("button");
            edit.textContent = "✏️";
            edit.onclick = () => {
              const newText = prompt("Edit:", msg.text);
              if (newText) updateDoc(doc(db, "servers", serverId, "channels", currentChannel, "messages", msgDoc.id), { text: newText });
            };
            div.appendChild(edit);
          }

          chatBox.appendChild(div);
        });
      });
    }

    window.sendMessage = async () => {
      const txt = messageInput.value.trim();
      if (!txt) return;
      const userDoc = await getDoc(doc(db, "users", currentUid));
      const { displayName, profilePicture, roleName, roleColor } = userDoc.data();

      await addDoc(collection(db, "servers", serverId, "channels", currentChannel, "messages"), {
        text: txt,
        displayName,
        sender: currentUid,
        timestamp: Date.now(),
        roleName: roleName || null,
        roleColor: roleColor || null
      });

      messageInput.value = "";
    };

    window.editServer = async () => {
      if (!isOwner) return;
      const newName = prompt("New server name:");
      if (newName) {
        await updateDoc(doc(db, "servers", serverId), { name: newName });
        serverName.textContent = newName;
      }
    };

    window.createChannel = async () => {
      const name = prompt("Channel name:");
      if (name) {
        await setDoc(doc(db, "servers", serverId, "channels", name), {});
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        channelSelect.appendChild(opt);
      }
    };

    window.createVoiceChannel = async () => {
      const name = prompt("Voice channel name:");
      if (name) {
        await setDoc(doc(db, "servers", serverId, "channels", name), { voice: true });
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name + " (VC)";
        channelSelect.appendChild(opt);
      }
    };

    window.createRole = async () => {
      const name = document.getElementById("roleName").value;
      const color = document.getElementById("roleColor").value;
      if (!name) return;
      await updateDoc(doc(db, "users", currentUid), {
        roleName: name,
        roleColor: color
      });
      alert("Role set!");
    };

    window.generateInvite = async () => {
      if (!isOwner || !isVerified) return alert("Only verified owners can do that.");
      const code = document.getElementById("inviteCode").value.trim();
      if (!code) return;
      await updateDoc(doc(db, "servers", serverId), {
        inviteCode: code
      });
      alert(`Invite: ${location.origin}/join.html?code=${code}`);
    };
  </script>
</body>
</html>
