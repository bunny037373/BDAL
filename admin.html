<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Panel</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #2c2f33;
      color: white;
      padding: 20px;
    }
    .user-card {
      background: #36393F;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 8px;
    }
    .user-card span {
      display: block;
      margin: 5px 0;
    }
    .blurred {
      filter: blur(5px);
      cursor: pointer;
    }
    .btn {
      padding: 5px 10px;
      margin-right: 5px;
      background: #5865F2;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .danger {
      background: #ff4444;
    }
    .section {
      margin-bottom: 40px;
    }
  </style>
</head>
<body>

  <h1>Administration Panel</h1>

  <button class="btn" onclick="backToMyAccount()">Back to My Account</button>

  <div class="section">
    <h2>Ban a Server</h2>
    <input type="text" id="serverBanId" placeholder="Enter Server ID">
    <button class="btn danger" onclick="banServer()">Ban Server</button>
  </div>

  <div class="section">
    <h2>All Users</h2>
    <div id="userList">Loading...</div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
    import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";
    import {
      getFirestore, collection, getDocs, updateDoc, doc, deleteDoc, setDoc
    } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCGGosrc7Ikl1xPnZri5sHuMvEUBB1f2YU",
      authDomain: "mydiscordclone-fc2be.firebaseapp.com",
      projectId: "mydiscordclone-fc2be",
      storageBucket: "mydiscordclone-fc2be.appspot.com",
      messagingSenderId: "599134697544",
      appId: "1:599134697544:web:0961e501044324e52b807d"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    let originalAdminUid = null;

    onAuthStateChanged(auth, async (user) => {
      if (!user) return location.href = "homescreen.html";
      const userDoc = await getDocs(collection(db, "users"));
      const isAdmin = userDoc.docs.find(doc => doc.id === user.uid && doc.data().role === "admin");
      if (!isAdmin) return location.href = "homescreen.html";

      originalAdminUid = user.uid;
      loadUsers();
    });

    async function loadUsers() {
      const usersSnap = await getDocs(collection(db, "users"));
      const userList = document.getElementById("userList");
      userList.innerHTML = "";

      usersSnap.forEach(docSnap => {
        const data = docSnap.data();
        const userId = docSnap.id;

        const div = document.createElement("div");
        div.className = "user-card";

        const emailSpan = document.createElement("span");
        emailSpan.textContent = data.email || "No email";
        emailSpan.className = "blurred";
        emailSpan.onclick = () => emailSpan.classList.remove("blurred");

        div.innerHTML = `
          <span><strong>${data.displayName || "User"}</strong></span>
          <span>Username: ${data.username || "(none)"}</span>
        `;

        div.appendChild(emailSpan);

        // Buttons
        const verifyBtn = document.createElement("button");
        verifyBtn.className = "btn";
        verifyBtn.textContent = data.verified ? "Unverify" : "Verify";
        verifyBtn.onclick = () => toggleVerify(userId, data.verified);

        const banBtn = document.createElement("button");
        banBtn.className = "btn danger";
        banBtn.textContent = "Ban";
        banBtn.onclick = () => banUser(userId, data.email);

        const unbanBtn = document.createElement("button");
        unbanBtn.className = "btn";
        unbanBtn.textContent = "Unban";
        unbanBtn.onclick = () => unbanUser(data.email);

        const spectateBtn = document.createElement("button");
        spectateBtn.className = "btn";
        spectateBtn.textContent = "Spectate";
        spectateBtn.onclick = () => {
          sessionStorage.setItem("adminViewingAs", userId);
          window.location.href = "home.html";
        };

        div.appendChild(verifyBtn);
        div.appendChild(banBtn);
        div.appendChild(unbanBtn);
        div.appendChild(spectateBtn);

        userList.appendChild(div);
      });
    }

    async function toggleVerify(uid, currentStatus) {
      await updateDoc(doc(db, "users", uid), {
        verified: !currentStatus
      });
      loadUsers();
    }

    async function banUser(uid, email) {
      await setDoc(doc(db, "bannedEmails", email), { banned: true });
      alert("User banned.");
    }

    async function unbanUser(email) {
      await deleteDoc(doc(db, "bannedEmails", email));
      alert("User unbanned.");
    }

    window.banServer = async () => {
      const serverId = document.getElementById("serverBanId").value.trim();
      if (!serverId) return alert("Enter a Server ID");
      await setDoc(doc(db, "bannedServers", serverId), { banned: true });
      alert("Server banned.");
    };

    window.backToMyAccount = () => {
      sessionStorage.removeItem("adminViewingAs");
      window.location.href = "home.html";
    };
  </script>
</body>
</html>
