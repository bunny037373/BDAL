<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>User Profile</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #1e1f22;
      color: white;
      text-align: center;
      padding-top: 40px;
    }

    img {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      margin-bottom: 10px;
    }

    h2 {
      margin: 10px 0 0;
    }

    p {
      margin: 5px 0 20px;
    }

    .badge {
      display: inline-block;
      padding: 2px 6px;
      font-size: 12px;
      border-radius: 4px;
      margin-left: 5px;
    }

    .verified { background: #1da1f2; }
    .dev { background: #28a745; }
    .admin { background: #ff6347; }

    .buttons button {
      background: #555;
      color: white;
      padding: 10px 15px;
      margin: 5px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .buttons button:disabled {
      background: #888;
      cursor: not-allowed;
    }
  </style>
</head>
<body>

  <div id="profile">
    <img id="pfp" src="default.png" alt="Profile Picture" />
    <h2 id="displayName">Display Name</h2>
    <h4 id="username">@username <span id="badges"></span></h4>
    <p id="bio">Bio goes here...</p>
  </div>

  <div class="buttons">
    <button id="friendBtn">Add Friend</button>
    <button id="msgBtn">Message</button>
    <button id="reportBtn">Report</button>
    <button id="blockBtn">Block</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, updateDoc, arrayUnion, arrayRemove
    } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCGGosrc7Ikl1xPnZri5sHuMvEUBB1f2YU",
      authDomain: "mydiscordclone-fc2be.firebaseapp.com",
      projectId: "mydiscordclone-fc2be",
      storageBucket: "mydiscordclone-fc2be.appspot.com",
      messagingSenderId: "599134697544",
      appId: "1:599134697544:web:0961e501044324e52b807d"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const params = new URLSearchParams(location.search);
    const targetId = params.get("uid");

    let currentUser;

    onAuthStateChanged(auth, async (user) => {
      if (!user || !targetId) return location.href = "login.html";
      currentUser = user;

      const targetSnap = await getDoc(doc(db, "users", targetId));
      if (!targetSnap.exists()) return alert("User not found.");

      const data = targetSnap.data();
      document.getElementById("pfp").src = data.profile || "default.png";
      document.getElementById("displayName").textContent = data.displayName || "Unknown";
      document.getElementById("username").textContent = "@" + data.username;
      document.getElementById("bio").textContent = data.bio || "";

      const badges = [];
      if (data.verified) badges.push('<span class="badge verified">✔️</span>');
      if (data.role === "dev") badges.push('<span class="badge dev">Dev</span>');
      if (data.role === "admin") badges.push('<span class="badge admin">Admin</span>');
      document.getElementById("badges").innerHTML = badges.join(" ");

      setupFriendButtons(user.uid, targetId, data);
    });

    async function setupFriendButtons(myUid, theirUid, data) {
      const friendBtn = document.getElementById("friendBtn");
      const msgBtn = document.getElementById("msgBtn");
      const blockBtn = document.getElementById("blockBtn");
      const reportBtn = document.getElementById("reportBtn");

      const mySnap = await getDoc(doc(db, "users", myUid));
      const myData = mySnap.data();
      const friends = myData.friends || [];
      const sent = myData.sent || [];
      const received = myData.received || [];
      const blocked = myData.blocked || [];

      const isMe = myUid === theirUid;
      if (isMe) {
        friendBtn.disabled = true;
        msgBtn.disabled = true;
        reportBtn.disabled = true;
        blockBtn.disabled = true;
        return;
      }

      if (friends.includes(theirUid)) {
        friendBtn.textContent = "Unfriend";
        friendBtn.onclick = async () => {
          await updateDoc(doc(db, "users", myUid), { friends: arrayRemove(theirUid) });
          await updateDoc(doc(db, "users", theirUid), { friends: arrayRemove(myUid) });
          location.reload();
        };
      } else if (sent.includes(theirUid)) {
        friendBtn.textContent = "Pending...";
        friendBtn.disabled = true;
      } else if (received.includes(theirUid)) {
        friendBtn.textContent = "Accept";
        const ignoreBtn = document.createElement("button");
        ignoreBtn.textContent = "Ignore";
        ignoreBtn.onclick = async () => {
          await updateDoc(doc(db, "users", myUid), { received: arrayRemove(theirUid) });
          await updateDoc(doc(db, "users", theirUid), { sent: arrayRemove(myUid) });
          location.reload();
        };
        friendBtn.onclick = async () => {
          await updateDoc(doc(db, "users", myUid), {
            received: arrayRemove(theirUid),
            friends: arrayUnion(theirUid)
          });
          await updateDoc(doc(db, "users", theirUid), {
            sent: arrayRemove(myUid),
            friends: arrayUnion(myUid)
          });
          location.reload();
        };
        document.querySelector(".buttons").appendChild(ignoreBtn);
      } else {
        friendBtn.textContent = "Add Friend";
        friendBtn.onclick = async () => {
          await updateDoc(doc(db, "users", myUid), { sent: arrayUnion(theirUid) });
          await updateDoc(doc(db, "users", theirUid), { received: arrayUnion(myUid) });
          location.reload();
        };
      }

      msgBtn.onclick = () => {
        if (!friends.includes(theirUid)) {
          return alert("System Error: we’re sorry but you are not friended to this person so you cannot message them anything until you added them. Please try again later.");
        }
        location.href = `messaging.html?uid=${theirUid}`;
      };

      blockBtn.textContent = blocked.includes(theirUid) ? "Unblock" : "Block";
      blockBtn.onclick = async () => {
        if (blocked.includes(theirUid)) {
          await updateDoc(doc(db, "users", myUid), { blocked: arrayRemove(theirUid) });
        } else {
          await updateDoc(doc(db, "users", myUid), { blocked: arrayUnion(theirUid) });
        }
        location.reload();
      };

      reportBtn.onclick = () => {
        alert("Report submitted.");
      };
    }
  </script>
</body>
</html>
